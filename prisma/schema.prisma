// Buy Ghana Lands - Prisma Schema
// NeonDB (Postgres) + PostGIS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  BUYER
  SELLER
  AGENT
  PROFESSIONAL
  ADMIN
  SUPPORT
  COMPLIANCE
  FINANCE
  MODERATOR
}

enum KycTier {
  TIER_0_OTP
  TIER_1_ID_UPLOAD
  TIER_2_GHANA_CARD
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum ListingStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  PUBLISHED
  SUSPENDED
  REJECTED
  ARCHIVED
  SOLD
}

enum ListingTenureType {
  FREEHOLD
  LEASEHOLD
  CUSTOMARY
}

enum ListingLandType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  AGRICULTURAL
  MIXED
}

enum VerificationLevel {
  LEVEL_0_UNVERIFIED
  LEVEL_1_DOCS_UPLOADED
  LEVEL_2_PLATFORM_REVIEWED
  LEVEL_3_OFFICIAL_VERIFIED
}

enum VerificationStatus {
  PENDING
  COMPLETED
  REJECTED
  CANCELLED
}

enum MediaType {
  PHOTO
  VIDEO
}

enum DocumentType {
  INDENTURE_DEED
  SITE_PLAN
  CADASTRAL_PLAN
  LAND_TITLE_CERTIFICATE
  LETTERS_OF_ADMINISTRATION
  FAMILY_RESOLUTION
  OTHER
  SELLER_ID
  VERIFICATION_CERTIFICATE
  TRANSACTION_AGREEMENT
}

enum AccessPolicy {
  PRIVATE
  LOGGED_IN_REDACTED
  TRANSACTION_PARTIES
  PUBLIC
}

enum OfferStatus {
  SENT
  COUNTERED
  ACCEPTED
  EXPIRED
  WITHDRAWN
}

enum TransactionStatus {
  CREATED
  ESCROW_REQUESTED
  FUNDED
  VERIFICATION_PERIOD
  DISPUTED
  READY_TO_RELEASE
  RELEASED
  REFUNDED
  PARTIAL_SETTLED
  CLOSED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  MEDIATION
  RESOLVED
  REJECTED
  CLOSED
}

enum ResolutionOutcome {
  RELEASE
  REFUND
  PARTIAL
  TERMINATE
}

enum PaymentProvider {
  FLUTTERWAVE
  PAYSTACK
  HUBTEL
  BANK_TRANSFER
  OTHER
}

enum PaymentType {
  LISTING_FEE
  TRANSACTION_FUNDING
  PAYOUT
  REFUND
  ADJUSTMENT
  PROFESSIONAL_PAYOUT
  SERVICE_FEE
}

enum PaymentStatus {
  INITIATED
  PENDING
  SUCCESS
  FAILED
  REVERSED
  CANCELLED
}

enum FraudCaseStatus {
  OPEN
  INVESTIGATING
  ACTION_TAKEN
  CLOSED
}

enum ReportTargetType {
  LISTING
  USER
  MESSAGE
  TRANSACTION
}

enum ReportStatus {
  OPEN
  IN_REVIEW
  ACTIONED
  DISMISSED
}

enum AuditEntityType {
  USER
  LISTING
  LISTING_VERSION
  OFFER
  TRANSACTION
  PAYMENT
  VERIFICATION_REQUEST
  DISPUTE
  FRAUD_CASE
  REPORT
  DOCUMENT
  MESSAGE
  KYC_REQUEST
  PERMIT_APPLICATION
  SUPPORT_TICKET
}

enum ActorType {
  USER
  SYSTEM
}

model User {
  id              String        @id @default(cuid())
  email           String?       @unique
  emailVerified   Boolean       @default(false)
  phone           String        @unique
  phoneVerified   Boolean       @default(false)
  passwordHash    String?
  fullName        String
  avatarUrl       String?
  roles           UserRole[]
  kycTier         KycTier       @default(TIER_0_OTP)
  accountStatus   AccountStatus @default(ACTIVE)
  language        String        @default("en")
  marketingOptIn  Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  listings             Listing[]              @relation("UserListings")
  offers               Offer[]                @relation("UserOffers")
  sentMessages         Message[]              @relation("UserSentMessages")
  receivedMessages     Message[]              @relation("UserReceivedMessages")
  transactionsAsBuyer  Transaction[]          @relation("BuyerTransactions")
  transactionsAsSeller Transaction[]          @relation("SellerTransactions")
  verificationRequests VerificationRequest[]  @relation("UserVerificationRequests")
  documents            Document[]             @relation("UserDocuments")
  reportsFiled         Report[]               @relation("UserReportsFiled")
  fraudCasesOpened     FraudCase[]            @relation("UserFraudCasesOpened")
  supportTickets       SupportTicket[]
  auditLogs            AuditLog[]
  documentAccessLogs   DocumentAccessLog[]
  listingVersions      ListingVersion[]
  verificationAssigned VerificationRequest[]  @relation("AssignedVerifications")
  disputes             Dispute[]
  payments             Payment[]              @relation("PayerPayments")
  payoutsReceived      Payment[]              @relation("PayeePayments")
  fraudCasesSubject    FraudCase[]            @relation("FraudCaseSubject")
  permitStatusChanges  PermitStatusHistory[]
  reviews              Review[]
  serviceRequests      ServiceRequest[]
  permitApplications   PermitApplication[]
  professionalProfile  ProfessionalProfile?

  // Pro features relations
  subscriptions          Subscription[]
  featuredListings       FeaturedListing[]
  listingAlerts          ListingAlert[]
  sellerBadge            SellerBadge?
  badgesIssued           SellerBadge[]          @relation("BadgeIssuer")
  escrowInsurances       EscrowInsurance[]
  insuranceClaims        InsuranceClaim[]
  documentVerifications  DocumentVerification[]
  agentProfile           AgentProfile?
  agentClients           AgentClient[]
  favorites              Favorite[]
  savedSearches          SavedSearch[]
  kycRequests            KycRequest[]
  kycReviewed            KycRequest[]           @relation("KycReviewer")
  deviceTokens           DeviceToken[]
  
  // Service charges
  serviceChargesPaid     ServiceCharge[]        @relation("ServiceChargePayer")
  serviceChargesReceived ServiceCharge[]        @relation("ServiceChargePayee")
  
  // Workflow relations
  propertyWorkflows      PropertyWorkflow[]

  @@index([createdAt])
  @@index([email])
  @@index([phone])
}

model OTPVerification {
  id        String   @id @default(cuid())
  phone     String   @unique
  code      String
  userId    String?
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model LandCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  landType    ListingLandType
  icon        String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]

  @@index([landType, isActive])
}

model Listing {
  id                String            @id @default(cuid())
  sellerId          String
  seller            User              @relation("UserListings", fields: [sellerId], references: [id])
  status            ListingStatus     @default(DRAFT)
  title             String
  description       String
  region            String
  constituency      String?
  district          String
  town              String?
  latitude          Decimal?          @db.Decimal(10, 7)
  longitude         Decimal?          @db.Decimal(10, 7)
  landType          ListingLandType
  categoryId        String?
  category          LandCategory?     @relation(fields: [categoryId], references: [id])
  tenureType        ListingTenureType
  leaseDurationYears Int?
  sizeAcres         Decimal           @db.Decimal(12, 4)
  totalPlots        Int               @default(1)
  availablePlots    Int               @default(1)
  soldPlots         Int               @default(0)
  pricePerPlotGhs   BigInt?
  priceGhs          BigInt
  negotiable        Boolean           @default(true)
  verificationLevel VerificationLevel @default(LEVEL_0_UNVERIFIED)
  currentVersionId  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  publishedAt       DateTime?
  expiresAt         DateTime?

  versions             ListingVersion[]
  media                ListingMedia[]
  documents            Document[]            @relation("ListingDocuments")
  boundaries           GeoBoundary[]
  offers               Offer[]
  transactions         Transaction[]
  reports              Report[]              @relation("ListingReports")
  verificationRequests VerificationRequest[]
  payments             Payment[]
  fraudCases           FraudCase[]
  messages             Message[]
  serviceRequests      ServiceRequest[]
  permitApplications   PermitApplication[]

  // Pro features relations
  featuredListings     FeaturedListing[]
  virtualTours         VirtualTour[]
  agentListings        AgentListing[]
  favorites            Favorite[]
  
  // Workflow relations
  propertyWorkflows    PropertyWorkflow[]

  @@index([sellerId, status])
  @@index([status, publishedAt])
  @@index([region, district])
}

model ListingVersion {
  id                 String            @id @default(cuid())
  listingId          String
  listing            Listing           @relation(fields: [listingId], references: [id])
  versionNumber      Int
  status             ListingStatus     @default(UNDER_REVIEW)
  title              String
  description        String
  region             String
  district           String
  town               String
  latitude           Decimal           @db.Decimal(10, 7)
  longitude          Decimal           @db.Decimal(10, 7)
  landType           ListingLandType
  tenureType         ListingTenureType
  leaseDurationYears Int?
  sizeAcres          Decimal           @db.Decimal(12, 4)
  sizePlots          Int?
  priceGhs           BigInt
  negotiable         Boolean
  createdById        String
  createdBy          User              @relation(fields: [createdById], references: [id])
  createdAt          DateTime          @default(now())

  @@unique([listingId, versionNumber])
  @@index([listingId, createdAt])
}

model ListingMedia {
  id           String    @id @default(cuid())
  listingId    String
  listing      Listing   @relation(fields: [listingId], references: [id])
  type         MediaType
  url          String
  thumbnailUrl String?
  sortOrder    Int       @default(0)
  width        Int?
  height       Int?
  durationSec  Int?
  createdAt    DateTime  @default(now())

  @@index([listingId, sortOrder])
}

model GeoBoundary {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  geojson   Json?
  areaSqm   Decimal? @db.Decimal(18, 4)
  createdAt DateTime @default(now())

  @@index([listingId])
}

model Document {
  id              String       @id @default(cuid())
  ownerId         String?
  owner           User?        @relation("UserDocuments", fields: [ownerId], references: [id])
  listingId       String?
  listing         Listing?     @relation("ListingDocuments", fields: [listingId], references: [id])
  transactionId   String?
  transaction     Transaction? @relation("TransactionDocuments", fields: [transactionId], references: [id])
  disputeId       String?
  dispute         Dispute?     @relation("DisputeDocuments", fields: [disputeId], references: [id])
  type            DocumentType
  accessPolicy    AccessPolicy @default(PRIVATE)
  url             String
  redactedUrl     String?
  sha256          String?      @db.VarChar(64)
  fileSizeBytes   BigInt?
  mimeType        String?
  virusScanStatus String?
  exifStripped    Boolean      @default(true)
  watermarked     Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  accessLogs      DocumentAccessLog[]
  permitDocuments PermitDocument[]
  bookings        Booking[]
  messages        Message[]

  // Pro features relations
  verifications   DocumentVerification[]

  @@index([listingId, type])
  @@index([transactionId, type])
}

model DocumentAccessLog {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id])
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  ip         String?
  userAgent  String?
  action     String
  createdAt  DateTime @default(now())

  @@index([documentId, createdAt])
  @@index([userId, createdAt])
}

model Offer {
  id            String      @id @default(cuid())
  listingId     String
  listing       Listing     @relation(fields: [listingId], references: [id])
  buyerId       String
  buyer         User        @relation("UserOffers", fields: [buyerId], references: [id])
  parentOfferId String?
  parentOffer   Offer?      @relation("OfferChain", fields: [parentOfferId], references: [id])
  counterOffers Offer[]     @relation("OfferChain")
  status        OfferStatus @default(SENT)
  amountGhs     BigInt
  message       String?
  expiresAt     DateTime
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  transaction Transaction?

  @@index([listingId, status])
  @@index([buyerId, createdAt])
}

model Transaction {
  id                  String            @id @default(cuid())
  listingId           String
  listing             Listing           @relation(fields: [listingId], references: [id])
  offerId             String?           @unique
  offer               Offer?            @relation(fields: [offerId], references: [id])
  buyerId             String
  buyer               User              @relation("BuyerTransactions", fields: [buyerId], references: [id])
  sellerId            String
  seller              User              @relation("SellerTransactions", fields: [sellerId], references: [id])
  status              TransactionStatus @default(CREATED)
  agreedPriceGhs      BigInt
  platformFeeBps      Int               @default(150)
  verificationDaysMin Int               @default(7)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  closedAt            DateTime?

  milestones       EscrowMilestone[]
  payments         Payment[]
  disputes         Dispute[]
  documents        Document[]         @relation("TransactionDocuments")
  messages         Message[]          @relation("TransactionMessages")
  supportTickets   SupportTicket[]
  serviceRequests  ServiceRequest[]
  permitApplications PermitApplication[]

  // Pro features relations
  escrowInsurance    EscrowInsurance?
  agentCommissions   AgentCommission[]
  serviceCharges     ServiceCharge[]

  @@index([buyerId, status])
  @@index([sellerId, status])
  @@index([listingId, status])
}

model EscrowMilestone {
  id                     String      @id @default(cuid())
  transactionId          String
  transaction            Transaction @relation(fields: [transactionId], references: [id])
  name                   String
  description            String?
  amountGhs              BigInt
  sortOrder              Int         @default(0)
  requiresBuyerApproval  Boolean     @default(true)
  requiresSellerApproval Boolean     @default(true)
  requiresAdminApproval  Boolean     @default(false)
  buyerApprovedAt        DateTime?
  sellerApprovedAt       DateTime?
  adminApprovedAt        DateTime?
  dueAt                  DateTime?
  completedAt            DateTime?
  createdAt              DateTime    @default(now())

  @@index([transactionId, sortOrder])
}

model Payment {
  id            String          @id @default(cuid())
  transactionId String?
  transaction   Transaction?    @relation(fields: [transactionId], references: [id])
  listingId     String?
  listing       Listing?        @relation(fields: [listingId], references: [id])
  provider      PaymentProvider
  type          PaymentType
  status        PaymentStatus   @default(INITIATED)
  currency      String          @default("GHS")
  amount        BigInt
  fees          BigInt          @default(0)
  netAmount     BigInt          @default(0)
  providerRef   String?         @unique
  receiptRef    String?
  payerUserId   String?
  payerUser     User?           @relation("PayerPayments", fields: [payerUserId], references: [id])
  payeeUserId   String?
  payeeUser     User?           @relation("PayeePayments", fields: [payeeUserId], references: [id])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([transactionId, type, status])
  @@index([listingId, type, status])
}

model VerificationRequest {
  id             String             @id @default(cuid())
  userId         String
  user           User               @relation("UserVerificationRequests", fields: [userId], references: [id])
  listingId      String
  listing        Listing            @relation(fields: [listingId], references: [id])
  levelRequested VerificationLevel
  status         VerificationStatus @default(PENDING)
  assignedToId   String?
  assignedTo     User?              @relation("AssignedVerifications", fields: [assignedToId], references: [id])
  checklist      Json?
  outcomeNotes   String?
  referenceNo    String?
  completedAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([listingId, status])
  @@index([userId, createdAt])
}

model Dispute {
  id                 String             @id @default(cuid())
  transactionId      String
  transaction        Transaction        @relation(fields: [transactionId], references: [id])
  raisedById         String
  raisedBy           User               @relation(fields: [raisedById], references: [id])
  status             DisputeStatus      @default(OPEN)
  summary            String
  details            String?
  sellerRespondedAt  DateTime?
  platformReviewedAt DateTime?
  resolvedAt         DateTime?
  resolutionOutcome  ResolutionOutcome?
  resolutionNotes    String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  documents Document[] @relation("DisputeDocuments")

  @@index([transactionId, status])
}

model Message {
  id              String       @id @default(cuid())
  senderId        String
  sender          User         @relation("UserSentMessages", fields: [senderId], references: [id])
  receiverId      String
  receiver        User         @relation("UserReceivedMessages", fields: [receiverId], references: [id])
  listingId       String?
  listing         Listing?     @relation(fields: [listingId], references: [id])
  transactionId   String?
  transaction     Transaction? @relation("TransactionMessages", fields: [transactionId], references: [id])
  body            String
  attachmentDocId String?
  attachmentDoc   Document?    @relation(fields: [attachmentDocId], references: [id])
  createdAt       DateTime     @default(now())
  readAt          DateTime?

  @@index([senderId, createdAt])
  @@index([receiverId, createdAt])
  @@index([transactionId, createdAt])
}

model Report {
  id         String           @id @default(cuid())
  reporterId String
  reporter   User             @relation("UserReportsFiled", fields: [reporterId], references: [id])
  targetType ReportTargetType
  targetId   String
  listingId  String?
  listing    Listing?         @relation("ListingReports", fields: [listingId], references: [id])
  status     ReportStatus     @default(OPEN)
  reason     String
  details    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([targetType, targetId])
  @@index([status, createdAt])
}

model FraudCase {
  id          String          @id @default(cuid())
  openedById  String
  openedBy    User            @relation("UserFraudCasesOpened", fields: [openedById], references: [id])
  listingId   String?
  listing     Listing?        @relation(fields: [listingId], references: [id])
  userId      String?
  user        User?           @relation("FraudCaseSubject", fields: [userId], references: [id])
  status      FraudCaseStatus @default(OPEN)
  summary     String
  evidence    Json?
  actionTaken String?
  closedAt    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status, createdAt])
  @@index([listingId])
  @@index([userId])
}

model SupportTicket {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  subject       String
  body          String
  status        String       @default("OPEN")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId, createdAt])
  @@index([transactionId, createdAt])
}

model AuditLog {
  id          String          @id @default(cuid())
  entityType  AuditEntityType
  entityId    String
  actorType   ActorType       @default(USER)
  actorUserId String?
  actorUser   User?           @relation(fields: [actorUserId], references: [id])
  action      String
  diff        Json?
  ip          String?
  userAgent   String?
  createdAt   DateTime        @default(now())

  @@index([entityType, entityId, createdAt])
  @@index([actorUserId, createdAt])
}

// Professional Services Marketplace

enum ProfessionalType {
  SURVEYOR
  LAWYER
  ARCHITECT
  ENGINEER
  PLANNER
  VALUER
  OTHER
}

enum ProfessionalLicenseStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum ServiceRequestStatus {
  OPEN
  OFFERED
  ACCEPTED
  DECLINED
  CANCELLED
  IN_PROGRESS
  DELIVERED
  COMPLETED
  DISPUTED
}

enum BookingStatus {
  REQUESTED
  CONFIRMED
  IN_PROGRESS
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
}

model ProfessionalProfile {
  id               String                    @id @default(cuid())
  userId           String                    @unique
  user             User                      @relation(fields: [userId], references: [id])
  professionalType ProfessionalType
  bio              String?
  companyName      String?
  yearsExperience  Int?
  serviceRegions   String[]
  baseLocation     String?
  latitude         Decimal?                  @db.Decimal(10, 7)
  longitude        Decimal?                  @db.Decimal(10, 7)
  licenseNumber    String?
  licenseBody      String?
  licenseStatus    ProfessionalLicenseStatus @default(UNVERIFIED)
  portfolioUrl     String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  services        ProfessionalService[]
  requests        ServiceRequest[]          @relation("ProfessionalRequests")
  bookings        Booking[]
  reviewsReceived Review[]                  @relation("ProfessionalReviews")

  @@index([professionalType, isActive])
}

model ProfessionalService {
  id             String              @id @default(cuid())
  professionalId String
  professional   ProfessionalProfile @relation(fields: [professionalId], references: [id])
  title          String
  description    String?
  priceGhs       BigInt?
  priceModel     String              @default("FIXED")
  turnaroundDays Int?
  isPublished    Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  serviceRequests ServiceRequest[]

  @@index([professionalId, isPublished])
}

model ServiceRequest {
  id               String               @id @default(cuid())
  requesterId      String
  requester        User                 @relation(fields: [requesterId], references: [id])
  listingId        String?
  listing          Listing?             @relation(fields: [listingId], references: [id])
  transactionId    String?
  transaction      Transaction?         @relation(fields: [transactionId], references: [id])
  professionalId   String?
  professional     ProfessionalProfile? @relation("ProfessionalRequests", fields: [professionalId], references: [id])
  serviceId        String?
  service          ProfessionalService? @relation(fields: [serviceId], references: [id])
  status           ServiceRequestStatus @default(OPEN)
  title            String
  details          String?
  preferredDate    DateTime?
  locationNote     String?
  offerPriceGhs    BigInt?
  acceptedPriceGhs BigInt?
  currency         String               @default("GHS")
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  closedAt         DateTime?

  booking Booking?

  @@index([requesterId, createdAt])
  @@index([professionalId, status])
}

model Booking {
  id               String         @id @default(cuid())
  serviceRequestId String         @unique
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  professionalId   String
  professional     ProfessionalProfile @relation(fields: [professionalId], references: [id])
  status           BookingStatus  @default(REQUESTED)
  scheduledAt      DateTime?
  startedAt        DateTime?
  deliveredAt      DateTime?
  completedAt      DateTime?
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  deliverables   Document[]
  reviews        Review[]
  serviceCharges ServiceCharge[]
}

model Review {
  id             String              @id @default(cuid())
  reviewerId     String
  reviewer       User                @relation(fields: [reviewerId], references: [id])
  professionalId String
  professional   ProfessionalProfile @relation("ProfessionalReviews", fields: [professionalId], references: [id])
  bookingId      String?
  booking        Booking?            @relation(fields: [bookingId], references: [id])
  rating         Int
  comment        String?
  createdAt      DateTime            @default(now())

  @@index([professionalId, createdAt])
  @@index([reviewerId, createdAt])
}

// Building Permit Processing

enum PermitApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  QUERY_RAISED
  RESUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum PermitDocType {
  SITE_PLAN
  ARCHITECTURAL_DRAWINGS
  STRUCTURAL_DRAWINGS
  FIRE_REPORT
  EPA_REPORT
  OWNERSHIP_DOCS
  ID_DOCS
  RECEIPT
  OTHER
  PERMIT_CERTIFICATE
}

model DistrictAssembly {
  id            String   @id @default(cuid())
  name          String   @unique
  region        String
  district      String
  contactEmail  String?
  contactPhone  String?
  officeAddress String?
  config        Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  permitApplications PermitApplication[]
  permitWorkflows   BuildingPermitWorkflow[] @relation("PermitWorkflowAssembly")

  @@index([region, district])
}

model PermitApplication {
  id                 String                  @id @default(cuid())
  applicantId        String
  applicant          User                    @relation(fields: [applicantId], references: [id])
  listingId          String?
  listing            Listing?                @relation(fields: [listingId], references: [id])
  transactionId      String?
  transaction        Transaction?            @relation(fields: [transactionId], references: [id])
  assemblyId         String
  assembly           DistrictAssembly        @relation(fields: [assemblyId], references: [id])
  status             PermitApplicationStatus @default(DRAFT)
  projectTitle       String
  projectDescription String?
  landLocationNote   String?
  plotSizeNote       String?
  estimatedCostGhs   BigInt?
  buildingType       String?
  storeys            Int?
  submittedAt        DateTime?
  decidedAt          DateTime?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  documents     PermitDocument[]
  statusHistory PermitStatusHistory[]
  queries       PermitQuery[]
  payments      PermitFeePayment[]

  @@index([applicantId, createdAt])
  @@index([assemblyId, status])
}

model PermitDocument {
  id                  String            @id @default(cuid())
  permitApplicationId String
  permitApplication   PermitApplication @relation(fields: [permitApplicationId], references: [id])
  type                PermitDocType
  documentId          String
  document            Document          @relation(fields: [documentId], references: [id])
  createdAt           DateTime          @default(now())

  @@index([permitApplicationId, type])
}

model PermitStatusHistory {
  id                  String                   @id @default(cuid())
  permitApplicationId String
  permitApplication   PermitApplication        @relation(fields: [permitApplicationId], references: [id])
  fromStatus          PermitApplicationStatus?
  toStatus            PermitApplicationStatus
  note                String?
  changedById         String?
  changedBy           User?                    @relation(fields: [changedById], references: [id])
  createdAt           DateTime                 @default(now())

  @@index([permitApplicationId, createdAt])
}

model PermitQuery {
  id                  String            @id @default(cuid())
  permitApplicationId String
  permitApplication   PermitApplication @relation(fields: [permitApplicationId], references: [id])
  title               String
  details             String?
  response            String?
  status              String            @default("OPEN")
  raisedAt            DateTime          @default(now())
  respondedAt         DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([permitApplicationId, raisedAt])
}

model PermitFeePayment {
  id                  String            @id @default(cuid())
  permitApplicationId String
  permitApplication   PermitApplication @relation(fields: [permitApplicationId], references: [id])
  feeType             String
  amount              BigInt
  currency            String            @default("GHS")
  status              PaymentStatus     @default(INITIATED)
  providerRef         String?
  paidAt              DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([permitApplicationId, feeType])
}

// USSD Support

enum UssdSessionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

model UssdSession {
  id        String            @id @default(cuid())
  msisdn    String
  sessionId String            @unique
  status    UssdSessionStatus @default(ACTIVE)
  menuPath  String[]
  data      Json?
  startedAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  endedAt   DateTime?

  @@index([msisdn, startedAt])
  @@index([status, updatedAt])
}

// API / Developer Platform

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  SUSPENDED
}

enum ApiScope {
  LISTINGS_READ
  LISTINGS_WRITE
  TRANSACTIONS_READ
  TRANSACTIONS_WRITE
  PROFESSIONALS_READ
  PROFESSIONALS_WRITE
  PERMITS_READ
  PERMITS_WRITE
  KYC_READ
  KYC_WRITE
  WEBHOOKS_MANAGE
  ADMIN_READ
}

model ApiClient {
  id          String       @id @default(cuid())
  name        String
  description String?
  contactEmail String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  apiKeys  ApiKey[]
  webhooks WebhookEndpoint[]
}

model ApiKey {
  id           String       @id @default(cuid())
  clientId     String
  client       ApiClient    @relation(fields: [clientId], references: [id])
  keyHash      String       @unique
  keyPrefix    String
  scopes       ApiScope[]
  status       ApiKeyStatus @default(ACTIVE)
  rateLimit    Int          @default(1000)
  lastUsedAt   DateTime?
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  usageLogs ApiUsageLog[]

  @@index([clientId, status])
}

model ApiUsageLog {
  id        String   @id @default(cuid())
  keyId     String
  key       ApiKey   @relation(fields: [keyId], references: [id])
  method    String
  path      String
  status    Int
  latencyMs Int
  ip        String?
  createdAt DateTime @default(now())

  @@index([keyId, createdAt])
  @@index([path, createdAt])
}

enum WebhookEventType {
  LISTING_CREATED
  LISTING_PUBLISHED
  LISTING_SUSPENDED
  OFFER_CREATED
  OFFER_ACCEPTED
  TRANSACTION_CREATED
  TRANSACTION_STATUS_CHANGED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  VERIFICATION_STATUS_CHANGED
  KYC_STATUS_CHANGED
  PERMIT_STATUS_CHANGED
  SERVICE_REQUEST_STATUS_CHANGED
}

enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
  DEAD
}

model WebhookEndpoint {
  id         String             @id @default(cuid())
  clientId   String
  client     ApiClient          @relation(fields: [clientId], references: [id])
  url        String
  secret     String
  events     WebhookEventType[]
  isActive   Boolean            @default(true)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  deliveries WebhookDelivery[]

  @@index([clientId, isActive])
}

model WebhookDelivery {
  id          String                @id @default(cuid())
  endpointId  String
  endpoint    WebhookEndpoint       @relation(fields: [endpointId], references: [id])
  eventType   WebhookEventType
  payload     Json
  status      WebhookDeliveryStatus @default(PENDING)
  attempts    Int                   @default(0)
  lastError   String?
  nextRetryAt DateTime?
  deliveredAt DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([endpointId, createdAt])
  @@index([status, nextRetryAt])
}

// KYC / Ghana Card Integration

enum KycStatus {
  INITIATED
  PENDING
  PASSED
  FAILED
  RETRY
  MANUAL_REVIEW
}

enum KycReason {
  SELLER_VERIFICATION
  HIGH_VALUE_TRANSACTION
  PROFESSIONAL_REGISTRATION
  MANUAL_REQUEST
}

model KycRequest {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  ghanaCardNumber String
  selfieUrl       String?
  reason          KycReason @default(MANUAL_REQUEST)
  status          KycStatus @default(INITIATED)
  providerRef     String?
  providerPayload Json?
  reviewNotes     String?
  reviewedById    String?
  reviewedBy      User?     @relation("KycReviewer", fields: [reviewedById], references: [id])
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, createdAt])
  @@index([status])
}

// Push Notification Device Tokens

enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

model DeviceToken {
  id         String         @id @default(cuid())
  userId     String
  user       User           @relation(fields: [userId], references: [id])
  token      String         @unique
  platform   DevicePlatform
  deviceName String?
  isActive   Boolean        @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([userId, isActive])
}

// Pro Features Models

// Legacy enum - kept for backward compatibility
enum SubscriptionPlan {
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

// New subscription category system
enum SubscriptionCategory {
  BUYER
  SELLER
  AGENT
  PROFESSIONAL
}

enum BuyerPlan {
  FREE
  PREMIUM
  VIP
}

enum SellerPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum AgentPlan {
  BASIC
  PRO
  ELITE
}

enum ProfessionalPlan {
  BASIC
  PRO
  ELITE
}

model Subscription {
  id                 String               @id @default(cuid())
  userId             String
  user               User                 @relation(fields: [userId], references: [id])
  
  // New category-based subscription
  category           SubscriptionCategory
  buyerPlan          BuyerPlan?
  sellerPlan         SellerPlan?
  agentPlan          AgentPlan?
  professionalPlan   ProfessionalPlan?
  
  // Legacy field - kept for backward compatibility
  plan               SubscriptionPlan?
  
  billingCycle       BillingCycle         @default(MONTHLY)
  priceGhs           Int
  status             SubscriptionStatus   @default(PENDING)
  features           Json?
  
  // Fee rates based on subscription tier
  transactionFeeRate Float?               // For sellers: fee rate on land sales
  serviceCommissionRate Float?            // For professionals: platform commission rate
  
  // Limits based on subscription tier
  listingLimit       Int?                 // Max listings for sellers
  clientLimit        Int?                 // Max clients for agents
  leadLimit          Int?                 // Max leads per month for professionals
  
  startDate          DateTime
  endDate            DateTime
  cancelledAt        DateTime?
  autoRenew          Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  payments SubscriptionPayment[]

  @@unique([userId, category, status]) // One active subscription per category per user
  @@index([userId, status])
  @@index([userId, category])
  @@index([endDate])
  @@index([status, endDate])
}

model SubscriptionPayment {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  amountGhs      Int
  status         PaymentStatus
  providerRef    String?
  paidAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([subscriptionId, createdAt])
}

// Service charges collected on transactions and professional services
enum ServiceChargeType {
  LAND_SALE_SELLER_FEE      // Fee charged to seller on land sale
  LAND_SALE_BUYER_FEE       // Fee charged to buyer (if any)
  PROFESSIONAL_SERVICE_FEE  // Platform commission on professional services
  AGENT_COMMISSION          // Agent commission on transactions
  LISTING_FEE               // Fee for listing (if applicable)
  VERIFICATION_FEE          // Fee for verification services
}

enum ServiceChargeStatus {
  PENDING       // Charge calculated but not yet collected
  COLLECTED     // Successfully collected
  WAIVED        // Charge waived (e.g., promotion)
  FAILED        // Collection failed
  REFUNDED      // Charge was refunded
}

model ServiceCharge {
  id              String              @id @default(cuid())
  
  // Link to transaction or booking
  transactionId   String?
  transaction     Transaction?        @relation(fields: [transactionId], references: [id])
  bookingId       String?
  booking         Booking?            @relation(fields: [bookingId], references: [id])
  
  // Charge details
  chargeType      ServiceChargeType
  status          ServiceChargeStatus @default(PENDING)
  
  // Amounts
  baseAmountGhs   BigInt              // Transaction/service value
  feeRate         Float               // Applied rate (e.g., 0.05 for 5%)
  feeAmountGhs    BigInt              // Calculated fee amount
  
  // Who pays
  payerId         String
  payer           User                @relation("ServiceChargePayer", fields: [payerId], references: [id])
  
  // Who receives (for agent commission)
  payeeId         String?
  payee           User?               @relation("ServiceChargePayee", fields: [payeeId], references: [id])
  
  // Subscription that determined the rate
  subscriptionId  String?
  
  // Collection details
  collectedAt     DateTime?
  paymentRef      String?             // Reference to payment record
  notes           String?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([transactionId, chargeType])
  @@index([bookingId, chargeType])
  @@index([payerId, createdAt])
  @@index([status, createdAt])
}

enum FeaturedListingStatus {
  PENDING_PAYMENT
  ACTIVE
  EXPIRED
  CANCELLED
}

model FeaturedListing {
  id        String                @id @default(cuid())
  listingId String
  listing   Listing               @relation(fields: [listingId], references: [id])
  userId    String
  user      User                  @relation(fields: [userId], references: [id])
  startDate DateTime
  endDate   DateTime
  priceGhs  Int
  priority  Int                   @default(0)
  status    FeaturedListingStatus @default(PENDING_PAYMENT)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([listingId, status])
  @@index([status, endDate])
}

enum AlertFrequency {
  INSTANT
  DAILY
  WEEKLY
}

model ListingAlert {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id])
  name            String
  criteria        Json
  notifyEmail     Boolean        @default(true)
  notifySms       Boolean        @default(false)
  frequency       AlertFrequency @default(INSTANT)
  isActive        Boolean        @default(true)
  lastTriggeredAt DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId, isActive])
  @@index([frequency, isActive])
}

enum SellerBadgeLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum SellerBadgeStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

model SellerBadge {
  id         String            @id @default(cuid())
  userId     String            @unique
  user       User              @relation(fields: [userId], references: [id])
  level      SellerBadgeLevel  @default(BRONZE)
  status     SellerBadgeStatus @default(ACTIVE)
  issuedAt   DateTime
  issuedById String?
  issuedBy   User?             @relation("BadgeIssuer", fields: [issuedById], references: [id])
  expiresAt  DateTime?
  revokedAt  DateTime?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@index([status, expiresAt])
}

enum VirtualTourType {
  PHOTO_360
  VIDEO
  DRONE
  WALKTHROUGH
}

model VirtualTour {
  id           String          @id @default(cuid())
  listingId    String
  listing      Listing         @relation(fields: [listingId], references: [id])
  type         VirtualTourType
  url          String
  thumbnailUrl String?
  title        String?
  description  String?
  sortOrder    Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([listingId, sortOrder])
}

enum InsuranceCoverageLevel {
  BASIC
  STANDARD
  PREMIUM
}

enum EscrowInsuranceStatus {
  PENDING_PAYMENT
  ACTIVE
  CLAIM_FILED
  CLAIM_APPROVED
  CLAIM_REJECTED
  EXPIRED
}

model EscrowInsurance {
  id                String                 @id @default(cuid())
  transactionId     String                 @unique
  transaction       Transaction            @relation(fields: [transactionId], references: [id])
  buyerId           String
  buyer             User                   @relation(fields: [buyerId], references: [id])
  coverageLevel     InsuranceCoverageLevel
  premiumGhs        Int
  coverageAmountGhs Int
  status            EscrowInsuranceStatus  @default(PENDING_PAYMENT)
  features          Json?
  expiresAt         DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  claims InsuranceClaim[]

  @@index([buyerId, status])
  @@index([status, expiresAt])
}

enum InsuranceClaimStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PAID
}

enum InsuranceClaimReason {
  FRAUD
  TITLE_ISSUE
  DOCUMENT_FORGERY
  SELLER_DEFAULT
  OTHER
}

model InsuranceClaim {
  id            String               @id @default(cuid())
  insuranceId   String
  insurance     EscrowInsurance      @relation(fields: [insuranceId], references: [id])
  claimantId    String
  claimant      User                 @relation(fields: [claimantId], references: [id])
  reason        InsuranceClaimReason
  description   String
  evidenceUrls  String[]
  claimAmountGhs Int
  approvedAmountGhs Int?
  status        InsuranceClaimStatus @default(SUBMITTED)
  reviewedById  String?
  reviewedAt    DateTime?
  reviewNote    String?
  paidAt        DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  @@index([insuranceId, status])
  @@index([claimantId, createdAt])
}

enum DocumentVerificationStatus {
  PENDING
  PASSED
  FAILED
  REVIEW_NEEDED
}

model DocumentVerification {
  id            String                     @id @default(cuid())
  documentId    String
  document      Document                   @relation(fields: [documentId], references: [id])
  requestedById String
  requestedBy   User                       @relation(fields: [requestedById], references: [id])
  documentType  String
  status        DocumentVerificationStatus @default(PENDING)
  checks        Json?
  completedAt   DateTime?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt

  @@index([documentId, createdAt])
  @@index([requestedById, createdAt])
}

model AgentProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  agencyName      String
  licenseNumber   String?
  bio             String?
  serviceRegions  String[]
  commissionRate  Float    @default(5)
  specializations String[]
  isVerified      Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  clients         AgentClient[]
  managedListings AgentListing[]
  commissions     AgentCommission[]

  @@index([isActive, isVerified])
}

enum AgentClientStatus {
  PENDING
  ACTIVE
  INACTIVE
}

model AgentClient {
  id        String            @id @default(cuid())
  agentId   String
  agent     AgentProfile      @relation(fields: [agentId], references: [id])
  clientId  String
  client    User              @relation(fields: [clientId], references: [id])
  status    AgentClientStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([agentId, clientId])
  @@index([agentId, status])
}

model AgentListing {
  id        String       @id @default(cuid())
  agentId   String
  agent     AgentProfile @relation(fields: [agentId], references: [id])
  listingId String
  listing   Listing      @relation(fields: [listingId], references: [id])
  createdAt DateTime     @default(now())

  @@unique([agentId, listingId])
  @@index([agentId])
}

model AgentCommission {
  id            String       @id @default(cuid())
  agentId       String
  agent         AgentProfile @relation(fields: [agentId], references: [id])
  transactionId String
  transaction   Transaction  @relation(fields: [transactionId], references: [id])
  amountGhs     Int
  rate          Float
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([agentId, status])
  @@index([transactionId])
}

model WhatsAppSession {
  id            String   @id @default(cuid())
  phone         String   @unique
  state         String   @default("MAIN_MENU")
  data          Json?
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([phone])
  @@index([lastMessageAt])
}

// User Favorites and Saved Searches

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
  @@index([userId, createdAt])
}

model SavedSearch {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  name         String
  filters      Json
  alertEnabled Boolean  @default(false)
  lastRunAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([alertEnabled])
}

// System Settings for Admin Configuration
model SystemSetting {
  id          String   @id @default(cuid())
  category    String   // e.g., "smtp", "payment", "sms", "storage", "general"
  key         String   // e.g., "SMTP_HOST", "PAYSTACK_SECRET_KEY"
  value       String   @db.Text // encrypted for sensitive values
  isEncrypted Boolean  @default(false)
  description String?
  updatedBy   String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@unique([category, key])
  @@index([category])
}

// ═══════════════════════════════════════════════════════════════════════════════
// WORKFLOW SYSTEM - Land Acquisition to Building Completion
// ═══════════════════════════════════════════════════════════════════════════════

enum WorkflowType {
  LAND_ACQUISITION
  PRE_CONSTRUCTION
  BUILDING_PERMIT
  CONSTRUCTION
  COMPLETION
}

enum WorkflowStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum StageStatus {
  LOCKED
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum LandOwnershipType {
  GOVERNMENT
  VESTED
  CUSTOMARY_STOOL
  FAMILY_PRIVATE
}

enum VerificationFindingStatus {
  PENDING
  CONFIRMED
  ISSUES_FOUND
  DISPUTED
}

enum NegotiationStatus {
  NOT_STARTED
  IN_PROGRESS
  AGREED
  FAILED
}

enum PossessionStatus {
  NOT_TAKEN
  MARKING_TERRITORY
  MONITORING
  SECURED
  DISPUTED
}

enum BuildingTypeEnum {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  MIXED_USE
  INSTITUTIONAL
}

enum DesignPhase {
  BRIEFING
  CONCEPTUAL
  DETAILED
  FINAL_REVIEW
  APPROVED
}

enum PermitWorkflowStatus {
  DRAFT
  DOCUMENTS_GATHERING
  READY_TO_SUBMIT
  SUBMITTED
  PRELIMINARY_REVIEW
  SITE_INSPECTION_SCHEDULED
  SITE_INSPECTION_COMPLETE
  TECHNICAL_REVIEW
  COMMITTEE_REVIEW
  APPROVED
  APPROVED_WITH_CONDITIONS
  DEFERRED
  REJECTED
  APPEAL_IN_PROGRESS
  PERMIT_ISSUED
}

enum InspectionOutcome {
  PASSED
  PASSED_WITH_CONDITIONS
  FAILED
  RESCHEDULED
}

enum ConstructionPhase {
  PRE_CONSTRUCTION
  FOUNDATION
  SUBSTRUCTURE
  SUPERSTRUCTURE
  ROOFING
  FINISHING
  EXTERNAL_WORKS
  FINAL_INSPECTION
  COMPLETION
}

enum ConstructionInspectionType {
  SITE_CLEARANCE
  FOUNDATION
  GROUND_FLOOR_SLAB
  FIRST_FLOOR_SLAB
  ROOF_LEVEL
  FINAL_COMPLETION
  FIRE_SAFETY
  ELECTRICAL
  PLUMBING
}

// Master Workflow - Links all modules together for a property
model PropertyWorkflow {
  id                String         @id @default(cuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  listingId         String?
  listing           Listing?       @relation(fields: [listingId], references: [id])
  
  propertyTitle     String?
  propertyAddress   String?
  region            String?
  district          String?
  town              String?
  plotNumber        String?
  landSizeAcres     Decimal?       @db.Decimal(10, 4)
  
  currentModule     WorkflowType   @default(LAND_ACQUISITION)
  overallStatus     WorkflowStatus @default(NOT_STARTED)
  overallProgress   Int            @default(0)
  
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  landAcquisition   LandAcquisitionWorkflow?
  preConstruction   PreConstructionWorkflow?
  buildingPermit    BuildingPermitWorkflow?
  construction      ConstructionWorkflow?
  workflowDocuments WorkflowDocument[]
  workflowNotes     WorkflowNote[]
  workflowAlerts    WorkflowAlert[]
  costTracker       WorkflowCostTracker?
  
  @@index([userId])
  @@index([listingId])
  @@index([currentModule, overallStatus])
}

// MODULE 1: LAND ACQUISITION WORKFLOW
model LandAcquisitionWorkflow {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String         @unique
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  currentStage          Int            @default(1)
  status                WorkflowStatus @default(NOT_STARTED)
  progress              Int            @default(0)
  
  // Stage 1: Pre-Purchase Due Diligence
  stage1Status          StageStatus    @default(NOT_STARTED)
  stage1Progress        Int            @default(0)
  lawyerEngaged         Boolean        @default(false)
  lawyerProfessionalId  String?
  surveyorEngaged       Boolean        @default(false)
  surveyorProfessionalId String?
  propertyInspections   Json?
  ownershipVerified     Boolean        @default(false)
  ownershipVerificationStatus VerificationFindingStatus @default(PENDING)
  landOwnershipType     LandOwnershipType?
  isForeignBuyer        Boolean        @default(false)
  
  // Stage 2: Independent Verification
  stage2Status          StageStatus    @default(LOCKED)
  stage2Progress        Int            @default(0)
  independentSurveyCommissioned Boolean @default(false)
  independentSurveyStatus String?
  surveyReportReceived  Boolean        @default(false)
  verifiedSitePlanObtained Boolean     @default(false)
  landsCommissionSearchDone Boolean    @default(false)
  searchFindings        Json?
  neighborConsultationDone Boolean     @default(false)
  neighborConsultationLog Json?
  
  // Stage 3: Negotiation & Agreement
  stage3Status          StageStatus    @default(LOCKED)
  stage3Progress        Int            @default(0)
  negotiationStatus     NegotiationStatus @default(NOT_STARTED)
  initialOfferGhs       Decimal?       @db.Decimal(15, 2)
  agreedPriceGhs        Decimal?       @db.Decimal(15, 2)
  paymentTerms          String?
  purchaseAgreementDrafted Boolean     @default(false)
  agreementCopiesCount  Int            @default(0)
  witnessesArranged     Boolean        @default(false)
  witnesses             Json?
  documentsSignedEndorsed Boolean      @default(false)
  
  // Stage 4: Payment & Documentation
  stage4Status          StageStatus    @default(LOCKED)
  stage4Progress        Int            @default(0)
  paymentMethod         String?
  totalPaidGhs          Decimal?       @db.Decimal(15, 2)
  payments              Json?
  stampDutyPaid         Boolean        @default(false)
  stampDutyAmountGhs    Decimal?       @db.Decimal(15, 2)
  vatPaid               Boolean        @default(false)
  vatAmountGhs          Decimal?       @db.Decimal(15, 2)
  registrationFeePaid   Boolean        @default(false)
  registrationFeeGhs    Decimal?       @db.Decimal(15, 2)
  allDocumentsGathered  Boolean        @default(false)
  
  // Stage 5: Land Registration
  stage5Status          StageStatus    @default(LOCKED)
  stage5Progress        Int            @default(0)
  submittedToLandsCommission Boolean   @default(false)
  landsCommissionSubmissionDate DateTime?
  landsCommissionRefNumber String?
  registrationStatus    String?        @default("NOT_SUBMITTED")
  valuationBoardStatus  String?
  irsTaxClearanceStatus String?
  deedsRegistryStatus   String?
  landTitleReceived     Boolean        @default(false)
  landTitleNumber       String?
  cadastralPlanReceived Boolean        @default(false)
  
  // Stage 6: Secure Physical Possession
  stage6Status          StageStatus    @default(LOCKED)
  stage6Progress        Int            @default(0)
  possessionStatus      PossessionStatus @default(NOT_TAKEN)
  territoryMarked       Boolean        @default(false)
  markingActions        Json?
  monitoringSchedule    String?
  securityHired         Boolean        @default(false)
  securityCompanyDetails String?
  lastSiteVisit         DateTime?
  nextScheduledVisit    DateTime?
  incidents             Json?
  
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([currentStage, status])
}

// MODULE 2: PRE-CONSTRUCTION PLANNING WORKFLOW
model PreConstructionWorkflow {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String         @unique
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  currentStage          Int            @default(7)
  status                WorkflowStatus @default(NOT_STARTED)
  progress              Int            @default(0)
  
  buildingAreaSqm       Decimal?       @db.Decimal(10, 2)
  numberOfStoreys       Int?
  buildingType          BuildingTypeEnum?
  estimatedBudgetGhs    Decimal?       @db.Decimal(15, 2)
  
  // Stage 7: Assemble Professional Team
  stage7Status          StageStatus    @default(NOT_STARTED)
  stage7Progress        Int            @default(0)
  
  architectRequired     Boolean        @default(false)
  architectEngaged      Boolean        @default(false)
  architectProfessionalId String?
  
  structuralEngineerRequired Boolean   @default(false)
  structuralEngineerEngaged Boolean    @default(false)
  structuralEngineerProfessionalId String?
  
  meEngineerRequired    Boolean        @default(false)
  meEngineerEngaged     Boolean        @default(false)
  meEngineerProfessionalId String?
  
  quantitySurveyorEngaged Boolean      @default(false)
  quantitySurveyorProfessionalId String?
  
  landSurveyorEngaged   Boolean        @default(false)
  landSurveyorProfessionalId String?
  
  professionalFeesEstimate Decimal?    @db.Decimal(15, 2)
  
  // Stage 8: Design Development
  stage8Status          StageStatus    @default(LOCKED)
  stage8Progress        Int            @default(0)
  designPhase           DesignPhase    @default(BRIEFING)
  
  projectBriefSubmitted Boolean        @default(false)
  projectBrief          Json?
  siteAnalysisComplete  Boolean        @default(false)
  siteAnalysis          Json?
  preliminaryDesignApproved Boolean    @default(false)
  designRevisionCount   Int            @default(0)
  
  architecturalDrawingsComplete Boolean @default(false)
  architecturalDrawings Json?
  structuralDrawingsComplete Boolean   @default(false)
  structuralDrawings    Json?
  meDrawingsComplete    Boolean        @default(false)
  meDrawings            Json?
  
  soilTestRequired      Boolean        @default(false)
  soilTestComplete      Boolean        @default(false)
  soilTestResults       Json?
  
  fireSafetyReportRequired Boolean     @default(false)
  fireSafetyReportComplete Boolean     @default(false)
  
  environmentalPermitRequired Boolean  @default(false)
  environmentalPermitObtained Boolean  @default(false)
  
  structuralAnalysisRequired Boolean   @default(false)
  structuralAnalysisComplete Boolean   @default(false)
  
  seismicDesignCompliant Boolean       @default(false)
  
  qsEstimateReceived    Boolean        @default(false)
  estimatedConstructionCostGhs Decimal? @db.Decimal(15, 2)
  costBreakdown         Json?
  
  allDrawingsComplete   Boolean        @default(false)
  professionalSignaturesVerified Boolean @default(false)
  clientFinalApproval   Boolean        @default(false)
  
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([currentStage, status])
}

// MODULE 3: BUILDING PERMIT APPLICATION WORKFLOW
model BuildingPermitWorkflow {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String         @unique
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  currentStage          Int            @default(9)
  status                WorkflowStatus @default(NOT_STARTED)
  progress              Int            @default(0)
  
  // Stage 9: Prepare Permit Application
  stage9Status          StageStatus    @default(NOT_STARTED)
  stage9Progress        Int            @default(0)
  
  districtAssemblyId    String?
  districtAssembly      DistrictAssembly? @relation("PermitWorkflowAssembly", fields: [districtAssemblyId], references: [id])
  
  applicationFormType   String?
  applicationFormComplete Boolean      @default(false)
  applicationFormData   Json?
  
  landOwnershipDocsUploaded Boolean    @default(false)
  architecturalDrawingsUploaded Boolean @default(false)
  structuralDrawingsUploaded Boolean   @default(false)
  proofOfIdentityUploaded Boolean      @default(false)
  surveyorCertificateUploaded Boolean  @default(false)
  
  firePermitRequired    Boolean        @default(false)
  firePermitUploaded    Boolean        @default(false)
  soilTestReportRequired Boolean       @default(false)
  soilTestReportUploaded Boolean       @default(false)
  fireSafetyReportRequired Boolean     @default(false)
  fireSafetyReportUploaded Boolean     @default(false)
  environmentalPermitRequired Boolean  @default(false)
  environmentalPermitUploaded Boolean  @default(false)
  structuralAnalysisRequired Boolean   @default(false)
  structuralAnalysisUploaded Boolean   @default(false)
  eiaRequired           Boolean        @default(false)
  eiaUploaded           Boolean        @default(false)
  
  documentCompletenessScore Int        @default(0)
  
  // Stage 10: Submit Application
  stage10Status         StageStatus    @default(LOCKED)
  stage10Progress       Int            @default(0)
  
  preSubmissionValidationPassed Boolean @default(false)
  submissionMethod      String?
  submissionDate        DateTime?
  applicationRefNumber  String?
  submissionReceiptUploaded Boolean    @default(false)
  
  processingFeeCalculated Boolean      @default(false)
  processingFeeGhs      Decimal?       @db.Decimal(15, 2)
  processingFeePaid     Boolean        @default(false)
  processingFeePaymentDate DateTime?
  processingFeeReceiptUploaded Boolean @default(false)
  
  // Stage 11: Review & Inspection Process
  stage11Status         StageStatus    @default(LOCKED)
  stage11Progress       Int            @default(0)
  applicationStatus     PermitWorkflowStatus @default(DRAFT)
  
  preliminaryReviewStatus String?
  reviewerAssigned      String?
  completenessCheckPassed Boolean?
  technicalCompliancePassed Boolean?
  zoningCompliancePassed Boolean?
  queriesRaised         Json?
  
  siteInspectionScheduled Boolean      @default(false)
  siteInspectionDate    DateTime?
  siteInspectionComplete Boolean       @default(false)
  siteInspectionOutcome InspectionOutcome?
  siteInspectionFindings Json?
  siteInspectionConditions Json?
  
  technicalReviewStatus String?
  departmentReviews     Json?
  technicalCommitteeRecommendation String?
  
  committeeReviewScheduled Boolean     @default(false)
  committeeMeetingDate  DateTime?
  committeeDecision     String?
  decisionDate          DateTime?
  decisionCommunicatedDate DateTime?
  
  deferralReasons       Json?
  rejectionReasons      Json?
  appealSubmitted       Boolean        @default(false)
  appealStatus          String?
  
  // Stage 12: Permit Issuance
  stage12Status         StageStatus    @default(LOCKED)
  stage12Progress       Int            @default(0)
  
  permitFeeCalculated   Boolean        @default(false)
  permitFeeGhs          Decimal?       @db.Decimal(15, 2)
  permitFeeDeadline     DateTime?
  permitFeePaid         Boolean        @default(false)
  permitFeePaymentDate  DateTime?
  permitFeeReceiptUploaded Boolean     @default(false)
  
  permitCertificateIssued Boolean      @default(false)
  permitNumber          String?
  permitIssueDate       DateTime?
  permitExpiryDate      DateTime?
  permitConditions      Json?
  permitCertificateUploaded Boolean    @default(false)
  
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([districtAssemblyId])
  @@index([applicationStatus])
  @@index([currentStage, status])
}

// MODULE 4: CONSTRUCTION EXECUTION WORKFLOW
model ConstructionWorkflow {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String         @unique
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  currentStage          Int            @default(13)
  status                WorkflowStatus @default(NOT_STARTED)
  progress              Int            @default(0)
  currentPhase          ConstructionPhase @default(PRE_CONSTRUCTION)
  
  // Stage 13: Pre-Construction Requirements
  stage13Status         StageStatus    @default(NOT_STARTED)
  stage13Progress       Int            @default(0)
  
  siteHoardingPermitRequired Boolean   @default(false)
  siteHoardingPermitObtained Boolean   @default(false)
  siteHoardingPermitExpiry DateTime?
  temporaryFacilitiesPermitObtained Boolean @default(false)
  
  districtInspectorNotified Boolean    @default(false)
  notificationDate      DateTime?
  inspectorAssigned     String?
  inspectorContact      String?
  
  contractorCompanyName String?
  contractorLicenseNumber String?
  contractorInsuranceDetails String?
  contractValue         Decimal?       @db.Decimal(15, 2)
  contractDurationMonths Int?
  contractDocumentUploaded Boolean     @default(false)
  healthSafetyPlanUploaded Boolean     @default(false)
  
  inspections           ConstructionInspection[]
  
  foundationStartDate   DateTime?
  foundationCompleteDate DateTime?
  foundationInspectionPassed Boolean?
  
  superstructureStartDate DateTime?
  superstructureCompleteDate DateTime?
  
  roofingStartDate      DateTime?
  roofingCompleteDate   DateTime?
  roofingInspectionPassed Boolean?
  
  finishingStartDate    DateTime?
  finishingCompleteDate DateTime?
  
  finalInspectionScheduled Boolean     @default(false)
  finalInspectionDate   DateTime?
  finalInspectionPassed Boolean?
  occupancyCertificateIssued Boolean   @default(false)
  occupancyCertificateNumber String?
  occupancyCertificateDate DateTime?
  
  constructionStartDate DateTime?
  constructionEndDate   DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([currentPhase, status])
}

// Construction Inspection Records
model ConstructionInspection {
  id                    String         @id @default(cuid())
  constructionWorkflowId String
  constructionWorkflow  ConstructionWorkflow @relation(fields: [constructionWorkflowId], references: [id], onDelete: Cascade)
  
  inspectionType        ConstructionInspectionType
  scheduledDate         DateTime?
  actualDate            DateTime?
  inspectorName         String?
  inspectorContact      String?
  
  outcome               InspectionOutcome?
  findings              Json?
  conditions            Json?
  photosUploaded        Boolean        @default(false)
  reportUploaded        Boolean        @default(false)
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([constructionWorkflowId])
  @@index([inspectionType])
}

// Workflow Documents
model WorkflowDocument {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  category              String
  subcategory           String?
  documentType          String
  title                 String
  description           String?
  
  fileUrl               String
  fileName              String
  fileSize              Int
  mimeType              String
  
  uploadedBy            String
  version               Int            @default(1)
  previousVersionId     String?
  
  isVerified            Boolean        @default(false)
  verifiedBy            String?
  verifiedAt            DateTime?
  
  expiryDate            DateTime?
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([category])
  @@index([documentType])
}

// Workflow Notes
model WorkflowNote {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  module                WorkflowType
  stage                 Int
  taskId                String?
  
  content               String         @db.Text
  createdBy             String
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([module, stage])
}

// Workflow Alerts & Reminders
model WorkflowAlert {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  alertType             String
  title                 String
  message               String         @db.Text
  
  module                WorkflowType?
  stage                 Int?
  taskId                String?
  
  triggerDate           DateTime?
  dueDate               DateTime?
  
  isRead                Boolean        @default(false)
  isDismissed           Boolean        @default(false)
  
  notificationSent      Boolean        @default(false)
  notificationSentAt    DateTime?
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
  @@index([alertType, isRead])
  @@index([triggerDate])
}

// Cost Tracker
model WorkflowCostTracker {
  id                    String         @id @default(cuid())
  propertyWorkflowId    String         @unique
  propertyWorkflow      PropertyWorkflow @relation(fields: [propertyWorkflowId], references: [id], onDelete: Cascade)
  
  landPurchasePrice     Decimal?       @db.Decimal(15, 2)
  legalFees             Decimal?       @db.Decimal(15, 2)
  surveyorFees          Decimal?       @db.Decimal(15, 2)
  stampDuty             Decimal?       @db.Decimal(15, 2)
  vat                   Decimal?       @db.Decimal(15, 2)
  registrationFees      Decimal?       @db.Decimal(15, 2)
  
  architectFees         Decimal?       @db.Decimal(15, 2)
  engineerFees          Decimal?       @db.Decimal(15, 2)
  quantitySurveyorFees  Decimal?       @db.Decimal(15, 2)
  soilTestFees          Decimal?       @db.Decimal(15, 2)
  otherProfessionalFees Decimal?       @db.Decimal(15, 2)
  
  processingFees        Decimal?       @db.Decimal(15, 2)
  permitFees            Decimal?       @db.Decimal(15, 2)
  firePermitFees        Decimal?       @db.Decimal(15, 2)
  environmentalPermitFees Decimal?     @db.Decimal(15, 2)
  
  constructionBudget    Decimal?       @db.Decimal(15, 2)
  constructionActual    Decimal?       @db.Decimal(15, 2)
  
  totalBudget           Decimal?       @db.Decimal(15, 2)
  totalActual           Decimal?       @db.Decimal(15, 2)
  
  costItems             Json?
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([propertyWorkflowId])
}

// Workflow Task Templates
model WorkflowTaskTemplate {
  id                    String         @id @default(cuid())
  
  module                WorkflowType
  stage                 Int
  taskOrder             Int
  
  taskKey               String
  title                 String
  description           String?        @db.Text
  helpText              String?        @db.Text
  
  isMandatory           Boolean        @default(false)
  isConditional         Boolean        @default(false)
  conditionLogic        Json?
  
  estimatedDurationDays Int?
  warningMessage        String?
  
  documentTypes         Json?
  linkedProfessionalType String?
  
  isActive              Boolean        @default(true)
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@unique([module, stage, taskKey])
  @@index([module, stage])
}
